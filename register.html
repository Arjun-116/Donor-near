<!DOCTYPE html>
<html>
<head>
    <title>Register</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="container">

<h2 class="text-danger mt-4">Donor Registration</h2>

<form class="mt-3" id="registrationForm">
  <input id="fullName" class="form-control my-2" placeholder="Full Name" required>
  
  <select id="bloodGroup" class="form-control my-2" required>
    <option value="">Select Blood Group</option>
    <option>A+</option><option>A-</option><option>B+</option><option>B-</option>
    <option>AB+</option><option>AB-</option><option>O+</option><option>O-</option>
  </select>
  
  <input id="phone" type="tel" class="form-control my-2" placeholder="Phone Number" required>
  <input id="city" class="form-control my-2" placeholder="City" required>

  <hr>
  <h6>Account Credentials</h6>
  <input id="email" class="form-control my-2" type="email" placeholder="Email Address" required>
  <input id="password" class="form-control my-2" type="password" placeholder="Password (min 6 chars)" required>
  
  <p class="text-muted small">üìç Location will be captured using GPS for proximity searching.</p>
  
  <button type="button" onclick="handleRegistration()" class="btn btn-danger mt-2 w-100">Create Account & Register</button>
</form>

<script type="module">
    // Import Auth and Firestore modules
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAhgBBtTeHiFziN6KUBtqLwJu5LZUlrMHo",
        authDomain: "donornear.firebaseapp.com",
        projectId: "donornear",
        storageBucket: "donornear.firebasestorage.app",
        messagingSenderId: "772619025659",
        appId: "1:772619025659:web:fe5f6bada8caeb7a0d045e"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    window.handleRegistration = function() {
        if (navigator.geolocation) {
            // Request High Accuracy GPS
            navigator.geolocation.getCurrentPosition(processRegistration, showError, {
                enableHighAccuracy: true,
                timeout: 10000
            });
        } else {
            alert("Geolocation is not supported by this browser.");
        }
    };

    async function processRegistration(position) {
        // Collect all form values
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const name = document.getElementById('fullName').value;
        const blood = document.getElementById('bloodGroup').value;
        const phone = document.getElementById('phone').value;
        const city = document.getElementById('city').value;

        // Basic Validation
        if(!email || !password || !name || !blood || !phone) {
            alert("Please fill in all fields.");
            return;
        }

        try {
            // 1. Create Login User in Firebase Auth
            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            const user = userCredential.user;

            // 2. Save Donor Profile to Firestore using the Auth UID
            // We use setDoc instead of addDoc so the document ID matches the User ID
            await setDoc(doc(db, "donors", user.uid), {
                name: name,
                bloodGroup: blood,
                phone: phone,
                city: city,
                email: email,
                latitude: position.coords.latitude,
                longitude: position.coords.longitude,
                createdAt: serverTimestamp()
            });

            alert("Registration Successful! You are now logged in.");
            window.location.href = "index.html"; // Redirect to home
            
        } catch (error) {
            console.error("Error during registration:", error);
            alert("Error: " + error.message);
        }
    }

    function showError(error) {
        alert("GPS Error: " + error.message);
    }
</script>

</body>
</html>