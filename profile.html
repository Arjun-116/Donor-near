<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DonorNear - Edit Profile</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="container py-4">

    <div class="mb-4">
        <a href="index.html" class="btn btn-outline-secondary btn-sm">‚Üê Back to Home</a>
    </div>

    <h2 class="text-danger fw-bold">Edit My Profile</h2>
    <p class="text-muted">Update your contact details and location to stay reachable in the network.</p>

    <div class="card p-4 shadow-sm border-0">
        <form id="profileForm">
            <div class="mb-3">
                <label class="form-label fw-bold">Full Name</label>
                <input id="profName" class="form-control bg-light" readonly>
            </div>

            <div class="mb-3">
                <label class="form-label fw-bold">Blood Group</label>
                <input id="profBlood" class="form-control bg-light" readonly>
            </div>

            <hr>

            <div class="mb-3">
                <label class="form-label fw-bold">Phone Number</label>
                <input id="profPhone" class="form-control" type="tel" placeholder="Edit your phone number">
            </div>

            <div class="mb-3">
                <label class="form-label fw-bold">Current City</label>
                <input id="profCity" class="form-control" placeholder="Edit your city">
            </div>

            <div class="alert alert-info py-2 small mb-3">
                <strong>üìç GPS Status:</strong> <span id="coordsDisplay">Loading...</span>
            </div>

            <button type="button" onclick="updateLocation()" class="btn btn-outline-danger w-100 mb-2">
                Update to Current GPS Location
            </button>
            
            <button type="button" onclick="saveProfile()" class="btn btn-success w-100 py-2">
                Save and Apply Changes
            </button>
        </form>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAhgBBtTeHiFziN6KUBtqLwJu5LZUlrMHo",
            authDomain: "donornear.firebaseapp.com",
            projectId: "donornear",
            storageBucket: "donornear.firebasestorage.app",
            messagingSenderId: "772619025659",
            appId: "1:772619025659:web:fe5f6bada8caeb7a0d045e"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let currentLat = null;
        let currentLng = null;

        // FETCH DATA: Fills the fields so you can see what to edit
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                const docRef = doc(db, "donors", user.uid);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    document.getElementById('profName').value = data.name;
                    document.getElementById('profBlood').value = data.bloodGroup;
                    document.getElementById('profPhone').value = data.phone;
                    document.getElementById('profCity').value = data.city;
                    document.getElementById('coordsDisplay').innerText = `${data.latitude.toFixed(4)}, ${data.longitude.toFixed(4)}`;
                    
                    currentLat = data.latitude;
                    currentLng = data.longitude;
                }
            } else {
                window.location.href = "login.html";
            }
        });

        // REFRESH GPS: Updates coordinates if the donor has moved
        window.updateLocation = function() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((pos) => {
                    currentLat = pos.coords.latitude;
                    currentLng = pos.coords.longitude;
                    document.getElementById('coordsDisplay').innerText = 
                        `${currentLat.toFixed(4)}, ${currentLng.toFixed(4)} (New GPS Captured!)`;
                }, (err) => alert("GPS Error: " + err.message), { enableHighAccuracy: true });
            }
        };

        // UPDATE DATA: Pushes your edits back to Firestore
        window.saveProfile = async function() {
            const newPhone = document.getElementById('profPhone').value;
            const newCity = document.getElementById('profCity').value;

            if(!newPhone || !newCity) return alert("Please fill in the phone and city fields.");

            try {
                // updateDoc only changes the fields you specify
                await updateDoc(doc(db, "donors", currentUser.uid), {
                    phone: newPhone,
                    city: newCity,
                    latitude: currentLat,
                    longitude: currentLng
                });
                alert("Success! Your profile details have been updated.");
            } catch (e) {
                console.error("Update error:", e);
                alert("Error saving details: " + e.message);
            }
        };
    </script>
</body>
</html>