<!DOCTYPE html>
<html>
<head>
    <title>Find Donors</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="container">

<h2 class="text-danger mt-4">Find Blood Donors</h2>

<select id="bloodSelect" class="form-control my-2">
  <option value="">Select Blood Group</option>
  <option>A+</option>
  <option>A-</option>
  <option>B+</option>
  <option>B-</option>
  <option>O+</option>
  <option>O-</option>
  <option>AB+</option>
  <option>AB-</option>
</select>

<select id="distSelect" class="form-control my-2">
  <option value="10">Within 10 km</option>
  <option value="25">Within 25 km</option>
  <option value="50" selected>Within 50 km</option>
  <option value="100">Within 100 km</option>
  <option value="500">Within 500 km</option>
</select>

<button onclick="startSearch()" class="btn btn-danger mt-2 w-100">Search</button>

<hr>

<h5>Search Results</h5>
<div id="results">
    <p class="text-muted">Results will appear here...</p>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAhgBBtTeHiFziN6KUBtqLwJu5LZUlrMHo",
        authDomain: "donornear.firebaseapp.com",
        projectId: "donornear",
        storageBucket: "donornear.firebasestorage.app",
        messagingSenderId: "772619025659",
        appId: "1:772619025659:web:fe5f6bada8caeb7a0d045e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    window.startSearch = function() {
        if (navigator.geolocation) {
            // enableHighAccuracy helps get the most precise location possible
            navigator.geolocation.getCurrentPosition(runQuery, (err) => alert(err.message), {enableHighAccuracy: true});
        } else {
            alert("GPS required.");
        }
    };

    async function runQuery(pos) {
        const group = document.getElementById('bloodSelect').value;
        const maxD = parseFloat(document.getElementById('distSelect').value);
        const resDiv = document.getElementById('results');

        if(!group) return alert("Please select a blood group");

        resDiv.innerHTML = "<div class='text-muted'>Searching database...</div>";
        
        try {
            // Firebase query filters donors matching the selected blood group
            const q = query(collection(db, "donors"), where("bloodGroup", "==", group));
            const snapshot = await getDocs(q);
            resDiv.innerHTML = "";

            if (snapshot.empty) {
                resDiv.innerHTML = `<p class='text-muted'>No donors found for group ${group}.</p>`;
                return;
            }

            snapshot.forEach(doc => {
                const d = doc.data();
                // Haversine distance formula used for calculating proximity
                const dist = calcDist(pos.coords.latitude, pos.coords.longitude, d.latitude, d.longitude);
                
                if(dist <= maxD) {
                    const donorCard = document.createElement('div');
                    donorCard.className = "my-3 p-3 border rounded shadow-sm bg-white";
                    donorCard.innerHTML = `
                        <h6 class="text-danger fw-bold">${d.name} (${d.bloodGroup})</h6>
                        <p class="mb-1">üìç ${d.city} | üìè <strong>${dist.toFixed(2)} km</strong> away</p>
                        <a href="tel:${d.phone}" class="btn btn-sm btn-outline-success">Call ${d.phone}</a>
                    `;
                    resDiv.appendChild(donorCard);
                }
            });
            
            if(resDiv.innerHTML === "") resDiv.innerHTML = "No donors found within this distance range.";
        } catch (e) { 
            console.error(e); 
            resDiv.innerHTML = "Error loading data. Check your Firestore connection."; 
        }
    }

    // Mathematical formula to calculate distance between two GPS points on Earth
    function calcDist(lat1, lon1, lat2, lon2) {
        const R = 6371; // Earth's radius in kilometers
        const dLat = (lat2-lat1) * Math.PI / 180;
        const dLon = (lon2-lon1) * Math.PI / 180;
        const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }
</script>

</body>
</html>